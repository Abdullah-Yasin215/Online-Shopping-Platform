<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 99999"></div>

<script src="~/lib/signalr.min.js"></script>
<script>
    // ===== SIMPLE CART SYSTEM =====

    // Global function to update cart count
    window.updateCartCount = function(count) {
        console.log("🔄 Updating cart count to:", count);
        const cartBadge = document.getElementById('cart-count');
        if (cartBadge) {
            cartBadge.textContent = count;
            console.log("✅ Cart badge updated to:", cartBadge.textContent);
        }
    };

    // Global function to show toast
    window.showCartToast = function(payload) {
        console.log("🎯 Showing toast:", payload);

        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '99999';
            document.body.appendChild(toastContainer);
        }

        // Remove existing toasts
        toastContainer.innerHTML = '';

        // Create new toast
        const toastId = 'cart-toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto">✅ Added to Cart</strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    <div class="fw-bold">${payload.quantity} × ${payload.name}</div>
                    <div class="text-muted small">Total items: ${payload.totalQuantity}</div>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        // Show the toast
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            // Try enabling toast using bootstrap global or window.bootstrap
            let bs = null;
            if (window.bootstrap) {
                bs = window.bootstrap;
            } else if (typeof bootstrap !== 'undefined') {
                bs = bootstrap;
            }

            if (bs && bs.Toast) {
                const toast = new bs.Toast(toastElement, {
                    autohide: true,
                    delay: 4000
                });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            } else {
                console.warn("Bootstrap not found, showing fallback alert");
                toastElement.className = "toast show"; // Fallback simple show
                setTimeout(() => toastElement.remove(), 4000);
            }
        }
    };

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log("🚀 Initializing cart system...");

        // Load initial cart count
        loadInitialCartCount();

        // Setup form handlers
        setupCartForms();

        // Start SignalR
        initializeSignalR();
    });

    function loadInitialCartCount() {
        console.log("📥 Loading initial cart count...");

        fetch('/cart/getcount')
            .then(response => response.json())
            .then(count => {
                console.log("✅ Initial cart count loaded:", count);
                updateCartCount(count);
            })
            .catch(err => {
                console.log("⚠️ Could not load cart count:", err);
            });
    }

    function setupCartForms() {
        console.log("🔧 Setting up cart forms (Event Delegation)...");

        // Use event delegation to handle clicks on any .add-to-cart-form, even dynamic ones
        document.body.addEventListener('submit', async function(e) {
            if (e.target && e.target.classList.contains('add-to-cart-form')) {
                e.preventDefault();
                await handleAddToCart(e.target);
            }
        });
    }

    async function handleAddToCart(form) {
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;

        try {
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';

            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                console.log('✅ Item added to cart:', result);

                // 1. Update cart count
                if (result.cartCount !== undefined) {
                    updateCartCount(result.cartCount);
                }
                
                // 2. Show Toast immediately (Fallback if SignalR is slow/disconnected)
                if (result.payload) {
                    showCartToast(result.payload);
                }

            } else {
                console.error('❌ Failed to add item to cart');
                alert('Failed to add item to cart. Please try again.');
            }
        } catch (error) {
            console.error('❌ Error adding item to cart:', error);
            alert('Error adding item to cart. Please try again.');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }
    }

    function initializeSignalR() {
        if (typeof signalR === 'undefined') {
            console.error("❌ SignalR not loaded");
            setTimeout(initializeSignalR, 100);
            return;
        }

        console.log("🛒 Connecting to SignalR...");

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/cart")
            .withAutomaticReconnect()
            .build();

        // Handle cart updates
        connection.on("ItemAddedToCart", function(payload) {
            console.log("🔥 SignalR message received:", payload);

            // Update cart count
            if (payload.totalQuantity !== undefined) {
                updateCartCount(payload.totalQuantity);
            }

            // Show toast
            showCartToast(payload);
        });

        // Start connection
        connection.start()
            .then(() => {
                console.log("✅ SignalR connected:", connection.connectionId);

                // Update forms with connection ID
                updateFormsWithConnectionId(connection.connectionId);
            })
            .catch(err => {
                console.error("❌ SignalR failed:", err);
            });
    }

    // ADD THIS MISSING FUNCTION:
    function updateFormsWithConnectionId(connectionId) {
        const forms = document.querySelectorAll('.add-to-cart-form');
        console.log(`🔗 Updating ${forms.length} forms with connection ID: ${connectionId}`);

        forms.forEach(form => {
            let input = form.querySelector('input[name="connectionId"]');
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'connectionId';
                form.appendChild(input);
            }
            input.value = connectionId;
        });
    }
</script>